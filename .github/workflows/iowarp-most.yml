name: IOWarp Most

on:
  workflow_dispatch:
  workflow_call:

jobs:
  # Step 1: Build core (depends on iowarp-deps from iowarp-all.yml)
  build-core:
    runs-on: ubuntu-latest
    steps:
      - name: Generate GitHub App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.IOWARP_APP_ID }}
          private-key: ${{ secrets.IOWARP_APP_PRIVATE_KEY }}
          owner: iowarp
          repositories: core

      - name: Trigger core Build Containers
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const response = await github.rest.actions.createWorkflowDispatch({
              owner: 'iowarp',
              repo: 'core',
              workflow_id: 'build-containers.yaml',
              ref: 'main'
            });
            console.log('Triggered core workflow');

      - name: Wait for core completion
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const pollInterval = 30000;
            const maxWaitTime = 3600000;
            const startTime = Date.now();

            while (Date.now() - startTime < maxWaitTime) {
              const runs = await github.rest.actions.listWorkflowRuns({
                owner: 'iowarp',
                repo: 'core',
                workflow_id: 'build-containers.yaml',
                per_page: 1
              });

              if (runs.data.workflow_runs.length > 0) {
                const latestRun = runs.data.workflow_runs[0];
                console.log(`Status: ${latestRun.status}, Conclusion: ${latestRun.conclusion}`);

                if (latestRun.status === 'completed') {
                  if (latestRun.conclusion === 'success') {
                    console.log('core build completed successfully');
                    return;
                  } else {
                    throw new Error(`core build failed with conclusion: ${latestRun.conclusion}`);
                  }
                }
              }

              await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            throw new Error('core build timed out');

  # Step 2: Build iowarp-build and iowarp (depends on core)
  build-iowarp:
    runs-on: ubuntu-latest
    needs: build-core
    timeout-minutes: 360
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx
      - name: Build and push iowarp-build
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ./docker/iowarp-build.Dockerfile
          builder: ${{ steps.buildx.outputs.name }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: iowarp/iowarp-build:latest
      - name: Build and push iowarp
        uses: docker/build-push-action@v6
        with:
          context: ./docker
          file: ./docker/iowarp.Dockerfile
          builder: ${{ steps.buildx.outputs.name }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: iowarp/iowarp:latest
