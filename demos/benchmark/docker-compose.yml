# WRP CTE Benchmark Docker Compose Configuration
#
# This compose file runs WRP CTE benchmarks with a separate iowarp runtime service.
# The iowarp service provides the CTE runtime, and the benchmark service connects to it.
#
# Architecture:
#   1. iowarp-runtime: Runs the CTE runtime daemon (iowarp/iowarp:latest)
#   2. wrp-cte-bench:  Runs the benchmark client (iowarp/cte-wrp-bench:latest)
#
# Usage:
#   docker-compose up                       # Run with default settings
#   docker-compose up -d iowarp-runtime     # Start runtime only
#   TEST_CASE=Get docker-compose up         # Override specific parameters
#   docker-compose down                     # Stop all services
#
# Environment Variables:
#   TEST_CASE         - Benchmark test: Put, Get, PutGet (default: Put)
#   NUM_PROCS         - Number of parallel processes (default: 1)
#   DEPTH             - Queue depth for concurrent operations (default: 4)
#   IO_SIZE           - Size of each I/O operation (default: 1m)
#                       Supports: b (bytes), k (KB), m (MB), g (GB)
#   IO_COUNT          - Number of operations to perform (default: 100)
#   CTE_INIT_RUNTIME  - Initialize CTE runtime in benchmark (default: 0, runtime handled by iowarp service)
#   WRP_CTE_CONF      - Path to CTE configuration file (default: /etc/iowarp/cte_config.yaml)

services:
  # IOWarp Runtime Service
  # Provides the CTE runtime daemon that benchmark clients connect to
  iowarp-runtime:
    image: iowarp/iowarp:latest
    container_name: iowarp-runtime

    # Mount shared CTE configuration
    volumes:
      - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro

    # Expose ZeroMQ port for client connections
    ports:
      - "5555:5555"

    # Environment variables for runtime configuration
    environment:
      # Path to CTE configuration file
      - WRP_CTE_CONF=/etc/iowarp/cte_config.yaml

      # Enable CTE runtime initialization
      - CTE_INIT_RUNTIME=1

    # Resource limits
    # Large shared memory for CTE operations
    shm_size: 8g
    mem_limit: 8g

    # Make IPC namespace shareable so benchmark containers can join
    ipc: shareable

    # Keep container running as a daemon
    stdin_open: true
    tty: true

    # Restart policy
    restart: unless-stopped

    # Health check to ensure runtime is ready
    healthcheck:
      test: ["CMD", "test", "-f", "/etc/iowarp/cte_config.yaml"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  # WRP CTE Benchmark Service
  # Runs benchmark tests against the iowarp runtime
  wrp-cte-bench:
    image: iowarp/iowarp-cte-bench:latest
    container_name: wrp-cte-bench

    # Depend on the runtime service
    depends_on:
      iowarp-runtime:
        condition: service_healthy

    # Mount shared CTE configuration
    volumes:
      - ./cte_config.yaml:/etc/iowarp/cte_config.yaml:ro

    # Environment variables for benchmark configuration
    environment:
      # CTE Runtime Configuration
      # Do NOT initialize runtime in benchmark (runtime service handles this)
      - CTE_INIT_RUNTIME=${CTE_INIT_RUNTIME:-0}

      # Path to CTE configuration file
      - WRP_CTE_CONF=${WRP_CTE_CONF:-/etc/iowarp/cte_config.yaml}

      # Benchmark Test Parameters
      # Test case selection: Put (write), Get (read), PutGet (mixed)
      - TEST_CASE=${TEST_CASE:-Put}

      # Number of parallel processes
      - NUM_PROCS=${NUM_PROCS:-1}

      # Queue depth for concurrent operations
      - DEPTH=${DEPTH:-4}

      # I/O operation size (supports b, k, m, g suffixes)
      - IO_SIZE=${IO_SIZE:-1m}

      # Number of operations to perform
      - IO_COUNT=${IO_COUNT:-100}

    # Network configuration to access runtime service
    network_mode: service:iowarp-runtime

    # IPC namespace sharing for shared memory access
    # This ensures both services can access the same shared memory segments
    ipc: service:iowarp-runtime

    # Resource limits
    # Match or exceed runtime service limits
    shm_size: 8g
    mem_limit: 8g

    # Clean up container after run
    restart: "no"
